<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <!--bootstrap icon-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- JQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <!-- CSS -->
  <link rel="stylesheet" href="main.css">
  <script src="javascript/cartOrder.js"></script>
  <title>ShopExpress</title>
</head>

<body>

  <header>
    <!-- main nav bar -->
    <nav class="navbar navbar-expand-sm bg-body-tertiary sticky-top">
      <div class="container-fluid">

        <a class="navbar-brand mb-1" href="index.html">ShopExpress</a>
        <form id="formSearch" class="form-inline my-2 my-lg-0 d-flex col-sm-7">
          <input class="form-control mr-sm-2 " type="search" placeholder="Search any product">
          <button class="btn btn-outline-success btn-sm my-2 my-sm-0 mx-2 mr-6" type="submit">Search</button>
        </form>
        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
          data-bs-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01" aria-expanded="false"
          aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse justify-content-end" id="navbarTogglerDemo01">

          <ul class="navbar-nav my-2 mb-lg-0 text-center  ">
            <li class="nav-item">
              <a class="nav-link" href="index.html">seller's center</a>
            </li>
            <li class="nav-item">
              <a class="btn btn-warning btn-sm mt-1 mx-1 px-2" id="signout">Sign out</a>
            </li>
            <li class="nav-item ">
              <a href="#" target="_blank"><i class="bi bi-cart-check-fill display-6 icon-link mx-2"></i></a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- nav bar -2 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown"
        aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
          <li class="nav-item active">
            <a class="nav-link" href="#">Best deals</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="productlist.html?category=Fashion">Fashion</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="productlist.html?category=Books">Books</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="productlist.html?category=Electronic">Electronic</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button"
              data-bs-toggle="dropdown" aria-expanded="false">
              More categories
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
              <a class="dropdown-item" href="productlist.html?category=Baby">Baby</a>
              <a class="dropdown-item" href="productlist.html?category=Home">Home</a>
              <a class="dropdown-item" href="productlist.html?category=Beauty">Beauty</a>
            </div>
          </li>
        </ul>
      </div>
    </nav>


  </header>

  <section class="container-fluid row m-5">
    <div id="shoppingCart" class="editPane rounded col-md-7 mx-4 ">
      <h1>Shopping Cart</h1>
      <div id="container-carts"></div>
    </div>

    <div class="editPane col-md-4 rounded ">
      <div class="row">
        <h5 class="mt-5">subtotal</h5>
        <span id="subtotalSpan"></span>
      </div>
      <div class="text-center">
        <button type="button" id="submitOrder" class="btn btn-secondary my-2">Submit order</button>
      </div>
    </div>

  </section>
  <footer>
    <div class="container navbar-dark">
      <p>Copyright &copy; 2023 by ShopExpress. All Rights Reserved.</p>
    </div>
  </footer>
  <!-- JavaScript bootstrap-->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
    crossorigin="anonymous"></script>
  <script>
    let ifLoggedIn = sessionStorage.getItem("ifLoggedIn");
    // initiate page-scope variables
    // these varaibles resets when page reloads
    let cartItems = [];
    let carts = [];

    $(document).ready(function () {
      // retrieve session data
      ifLoggedIn = sessionStorage.getItem("ifLoggedIn");
      username = sessionStorage.getItem("username");
      password = sessionStorage.getItem('password');
      role = sessionStorage.getItem('role');

      // reset page-scoped variables
      cartItems = [];
      carts = [];

      if (ifLoggedIn !== "true") {
        alert("Access Forbidden: you are not logged in!");
        window.location.href = "index.html";
      } else {
        refreshCart()
      }
    });

    function refreshCart() {
      // get cart id by buyerId (user id)
      $.ajax({
        url: "/api/carts/",
        type: "GET",
        headers: {
          'x-auth-username': username,
          'x-auth-password': password,
          'x-auth-role': role
        },
        error: function (jqxhr, status, errorThrown) {
          alert("AJAX error: " + jqxhr.responseText + ", status: " + jqxhr.status);
        }
      }).done(function (data, status, xhr) {
        carts = data;
        // get item details of each cart
        for (cart of carts) {
          $.ajax({
            url: "/api/cartItem/" + cart.id,
            type: "GET",
            headers: {
              'x-auth-username': username,
              'x-auth-password': password,
              'x-auth-role': role
            },
            error: function (jqxhr, status, errorThrown) {
              alert("AJAX error: " + jqxhr.responseText + ", status: " + jqxhr.status);
            }
          }).done(function (data, status, xhr) {
            let cartCard = "";
            cartItems = cartItems.concat(data);

            for (cartItem of data) {
              $.ajax({
                url: "/api/products/" + cartItem.productId,
                type: "GET",
                headers: {
                  'x-auth-username': username,
                  'x-auth-password': password,
                  'x-auth-role': role
                },
                error: function (jqxhr, status, errorThrown) {
                  alert("AJAX error: " + jqxhr.responseText + ", status: " + jqxhr.status);
                }
              }).done(function (product, status, xhr) {
                // get image info
                $.ajax({
                  url: "/api/images/?productId=" + product.id,
                  type: "GET",
                  headers: {
                    'x-auth-username': username,
                    'x-auth-password': password,
                    'x-auth-role': role
                  },
                  error: function (jqxhr, status, errorThrown) {
                    alert("AJAX error: " + jqxhr.responseText + ", status: " + jqxhr.status);
                  }
                }).done(function (allImages, status, xhr) {
                  let image = allImages[0];
                  cartCard += `<div class="card mb-3" style="max-width: 800px; max-height:300px;">
                                <div class="form-check">
                                  <input id="${cartItem.id}" class="form-check-input " type="checkbox" value=""/>
                                </div>
                                <div class="row g-0">
                                  <div class="col-md-4 ">
                                    <img id="${(image) ? image.id : 38}"
                                    class="img-fluid rounded-start cropped"
                                    src="api/images/${(image) ? image.id : 38}" 
                                    alt="${product.productName}"
                                    style="height: 100%; object-fit: cover;">
                                  </div>
                                  <div class="col-md-8">
                                    <div class="card-body">
                                      <h5 class="card-title">
                                        ${cartItem.productName} </h5>
                                      <h4>Price: ${cartItem.price}</h4>
                                        <p class="card-text">ProductId: ${cartItem.productCode}</p>                                      
                                      <input class="input-amout" type="number" min="0" value="${cartItem.amount}">
                                      <button id="delete" type="button" class="btn btn-secondary btn-sm">Delete</button>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>`;
                  $("#container-carts").append(cartCard);
                })
              });
            }
          })
        }
      })
    }

    $('#container-carts').on("click", '#delete', function () {
      let checkeds = $(".form-check-input:checked");
      checkeds.each(function(index){
        let i = $(this).id;
        $.ajax({
          url: "/api/cartItem/",
          type: "DELETE",
          dataType: "JSON",
          data: cartItems.find(x => x.id == i),
          headers: {
            'x-auth-username': sessionStorage.getItem('username'),
            'x-auth-password': sessionStorage.getItem('password'),
            'x-auth-role': sessionStorage.getItem('role')
          },
          error: function (jqxhr, status, errorThrown) {
            alert("AJAX error: " + jqxhr.responseText + ", status: " + jqxhr.status);
          }
        }).done(function () {
          // remove this cart item from front-end array
          cartItems.splice(i, 1);
          refreshCart();
        })
      }
      ) 
    });

    $("#submitOrder").on("click", function(){
      let checkeds = $(".form-check-input:checked");
      checkeds.each(function(index){
        let i = $(this).id;
        let cartItem = cartItems.find(x => x.id == i);
        let order = {
          id: i,
          productId: cartItem.productId,
          amount: cartItem.amount
        };
        // add order to order table
        $.ajax({
          url: "/api/order/",
          type: "POST",
          dataType: "JSON",
          data: order,
          headers: {
            'x-auth-username': sessionStorage.getItem('username'),
            'x-auth-password': sessionStorage.getItem('password'),
            'x-auth-role': sessionStorage.getItem('role')
          },
          error: function (jqxhr, status, errorThrown) {
            alert("AJAX error: " + jqxhr.responseText + ", status: " + jqxhr.status);
          }
        }).done(function(){
          refreshCart();          
        })
      })
      window.location.href = "orderhistory.html";
    })


    $("#container-carts").on("change", ".form-check-input", function () {
      calculateSubTotal();
    })

    $("#container-carts").on("change", ".input-amout", function () {
      calculateSubTotal();
    })

    

    function calculateSubTotal() {
      let checkeds = $(".form-check-input:checked");
      let subtotal = 0;
      checkeds.each(function (index) {
        let price = parseFloat($(this).parent().parent().children().eq(1).children().eq(1).children().eq(0).children().eq(1).text().substring(7));
        let amount = parseInt($(this).parent().parent().children().eq(1).children().eq(1).children().eq(0).children().eq(3).val());
        subtotal += price * amount;
      })
      $("#subtotalSpan").text(subtotal);
    }

    $("#container-carts").on("click", "img", function () {
      // not required for now
      // let id = $(this).id;
    })

    $("#signout").click(function () {
      ifLoggedIn = "false";
      sessionStorage.clear();
      window.open("index.html");
    });
  </script>
</body>

</html>